<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BharathTube</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Preload logo -->
    <link rel="preload" href="/static/logo.png" as="image">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous" defer></script>

    <style>
        body {
            background: #f9f9f9;
            font-family: Arial, sans-serif;
        }
        .navbar {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 10px 20px;
        }
        .navbar img {
            height: 40px;
        }
        .search-container {
            max-width: 600px;
            margin: 20px auto;
            position: relative;
        }
        #searchInput {
            padding: 10px 40px 10px 15px;
            border-radius: 20px;
            border: 1px solid #ccc;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        .suggestions {
            position: absolute;
            background: white;
            z-index: 1000;
            width: 100%;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 10px 10px;
        }
        .suggestions li {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestions li:hover {
            background: #f1f1f1;
        }
        .video-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        video, img {
            width: 100%;
            border-radius: 8px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-download, .btn-delete {
            flex: 1;
        }
        .footer {
            background: #343a40;
            color: white;
            text-align: center;
            padding: 15px;
        }
    </style>
</head>
<body>

<!-- Logo Navbar -->
<nav class="navbar d-flex justify-content-center">
    <img src="/static/logo.png" alt="BharathTube Logo">
</nav>

<div class="container mt-4">
    <!-- Upload -->
    <form id="uploadForm" class="mb-4">
        <div class="input-group mb-3">
            <input type="file" name="file" class="form-control" required>
            <button type="submit" class="btn btn-danger">Upload</button>
        </div>
        <div class="progress" style="display:none;">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
        </div>
    </form>

    <!-- Search -->
    <div class="search-container">
        <input type="text" id="searchInput" class="form-control" placeholder="Search BharathTube...">
        <i class="fas fa-search search-icon"></i>
        <ul class="suggestions list-unstyled" id="suggestions"></ul>
    </div>

    <!-- Content -->
    <div id="fileContainer" class="mt-4">
        {% for filename in filenames %}
            <div class="video-card" data-name="{{ filename }}">
                {% if filename.endswith('.mp4') or filename.endswith('.webm') or filename.endswith('.mkv') %}
                    <video controls loading="lazy">
                        <source src="/stream/{{ filename }}" type="video/mp4">
                    </video>
                {% elif filename.endswith('.jpg') or filename.endswith('.jpeg') or filename.endswith('.png') or filename.endswith('.gif') %}
                    <img src="/stream/{{ filename }}" alt="{{ filename }}" loading="lazy">
                {% endif %}
                <h6 class="mt-2">{{ filename }}</h6>
                <div class="btn-group">
    <!-- Manual Download -->
    <a href="/download/{{ filename }}" class="btn btn-outline-primary btn-download">
        <i class="fas fa-download"></i> Download
    </a>

    <!-- QR Code -->
    <button type="button" class="btn btn-outline-success w-100"
            data-bs-toggle="modal" data-bs-target="#qrModal"
            data-filename="{{ filename }}">
        <i class="fas fa-qrcode"></i> QR Code
    </button>

    <!-- Delete -->
    <form method="POST" action="/delete/{{ filename }}" onsubmit="return confirm('Delete this file?')" class="d-inline w-100">
        <button type="submit" class="btn btn-outline-danger btn-delete w-100">
            <i class="fas fa-trash"></i> Delete
        </button>
    </form>
</div>

            </div>
        {% endfor %}
    </div>
</div>

<!-- Footer -->
<div class="footer">
    Developed by <span><strong>Bharath Kumar Mattapally</strong></span>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3 text-center">
      <h5 class="modal-title mb-3" id="qrModalLabel">Scan to Download</h5>
      <img id="qrImage" src="" alt="QR Code" class="img-fluid mx-auto d-block" style="max-width:250px;">
      <p class="mt-2 text-muted">Scan with your phone to download</p>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script defer>
    const searchInput = document.getElementById('searchInput');
    const fileCards = document.querySelectorAll('.video-card');
    const suggestions = document.getElementById('suggestions');

    function filterFiles(query) {
        const q = query.toLowerCase();
        fileCards.forEach(card => {
            const name = card.getAttribute('data-name');
            card.style.display = name.includes(q) ? "" : "none";
        });
    }

    let debounceTimer;
    searchInput.addEventListener('input', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = searchInput.value.toLowerCase();
            suggestions.innerHTML = "";
            let matches = [];

            fileCards.forEach(card => {
                const name = card.getAttribute('data-name');
                if (name.includes(query)) {
                    matches.push(name);
                }
            });

            if (query && matches.length) {
                [...new Set(matches)].slice(0, 10).forEach(match => {
                    const li = document.createElement('li');
                    li.textContent = match;
                    li.onclick = () => {
                        searchInput.value = match;
                        suggestions.innerHTML = "";
                        filterFiles(match);
                    };
                    suggestions.appendChild(li);
                });
            }

            filterFiles(query);
        }, 300); // Debounce 300ms
    });

    searchInput.addEventListener('keydown', function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            filterFiles(this.value);
            suggestions.innerHTML = "";
        }
    });

    // Upload with progress
    document.getElementById('uploadForm').addEventListener('submit', function (event) {
        event.preventDefault();

        let formData = new FormData(this);
        let progressBar = document.getElementById('progressBar');
        let progressContainer = document.querySelector('.progress');
        progressBar.style.width = "0%";
        progressBar.innerText = "0%";
        progressContainer.style.display = "block";

        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);

        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                let percent = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                progressBar.innerText = "Upload Complete!";
                setTimeout(() => location.reload(), 1000);
            }
        };

        xhr.send(formData);
    });
    // QR Modal handling
const qrModal = document.getElementById('qrModal');
qrModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const filename = button.getAttribute('data-filename');
    const qrImage = document.getElementById('qrImage');
    qrImage.src = `/qr/${filename}`;
});

</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

</body>
</html>
